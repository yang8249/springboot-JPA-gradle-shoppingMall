{{>layouts/header}}

<div class="container py-3">
    <h4>관리자 문의 채팅</h4>
    <div id="chat-box" class="border rounded p-2" style="height:420px;overflow:auto;"></div>

    <div class="d-flex gap-2 mt-2">
        <input id="chat-input" class="form-control" placeholder="메시지를 입력..." />
        <button id="send-btn" class="btn btn-primary">전송</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const roomId = "{{roomId}}";

  function appendMsg(m) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.textContent = `[${m.sentAt}] ${m.senderNick}: ${m.content}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  function loadHistory() {
    fetch('/api/inquiry/history?roomId=' + encodeURIComponent(roomId))
      .then(r => r.json()).then(list => list.forEach(appendMsg));
  }

  let stomp;
  function connect() {
    const sock = new SockJS('/ws');
    stomp = Stomp.over(sock);
    stomp.connect({}, () => {
      stomp.subscribe('/topic/inq.' + roomId, frame => {
        appendMsg(JSON.parse(frame.body));
      });
      loadHistory();
    });
  }

  function send() {
    const i = document.getElementById('chat-input');
    const content = i.value.trim();
    if (!content) return;
    stomp.send('/app/inq.send', {}, JSON.stringify({ roomId, content }));
    i.value = '';
  }

  document.getElementById('send-btn').onclick = send;
  document.getElementById('chat-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') send();
  });

  connect();
</script>

{{>layouts/footer}}